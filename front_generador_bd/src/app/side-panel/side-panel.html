<div class="flex flex-col w-64 h-full bg-gray-50 border-r border-gray-200 shadow-md p-4 space-y-6 overflow-y-scroll">

  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold text-gray-800"> Herramientas UML</h2>
    <button class="text-sm text-red-500 hover:text-red-700 font-medium transition" (click)="goHome()">
      ‚¨ÖÔ∏è Salir
    </button>
  </div>

  <!-- Paleta de elementos -->
  <button (click)="showPalette=!showPalette"
    class="w-full bg-slate-700 text-white rounded-lg py-3 font-semibold mb-2 flex items-center justify-center gap-1 shadow-md transition hover:bg-slate-800">
    <span class="text-center">Paleta de elementos</span>
    <span>
      @if (showPalette) {
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
      </svg>
      } @else {
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
      </svg>
      }
    </span>
  </button>
  @if(showPalette){
  <div class="space-y-2">
    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag [cdkDragData]="{ type: 'class' }" (cdkDragEnded)="onDragEnded($event)">
      üì¶ <span class="ml-1">Clase UML</span>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag [cdkDragData]="{ type: 'association' }" (cdkDragEnded)="onDragEnded($event)">
      <div class="flex items-center gap-4 w-full justify-center py-1">
        <span class="inline-block align-middle" style="width:100px;height:28px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="103%" height="100%" viewBox="25 -5 165 20">
            <g>
              <path d="M 7 7 L 158.88 7" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10"
                pointer-events="stroke" />
              <path d="M 165.88 7 L 158.88 10.5 L 158.88 3.5 Z" fill="none" stroke="#222" stroke-width="2.8"
                stroke-miterlimit="10" pointer-events="all" />
            </g>
          </svg>
        </span>
        <span class="font-semibold text-base text-gray-900">Asociaci√≥n</span>
      </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition flex items-center"
      cdkDrag [cdkDragData]="{ type: 'generalization' }" (cdkDragEnded)="onDragEnded($event)">
      <div class="flex items-center gap-7 w-full justify-center py-1">
        <span class="inline-block align-middle" style="width:100px;height:28px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="25 5 165 20">
            <g>
              <path d="M 24 18 L 150 18" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10"
                pointer-events="stroke" />
              <path d="M 170 18 L 150 28 L 150 8 Z" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10"
                pointer-events="all" />
            </g>
          </svg>
        </span>
        <span class="font-semibold text-base text-gray-900">Herencia</span>
      </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag [cdkDragData]="{ type: 'aggregation' }" (cdkDragEnded)="onDragEnded($event)">
      <div class="flex items-center gap-4 w-full justify-center py-1">
        <span class="inline-block align-middle" style="width:100px;height:28px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="110%" height="100%" viewBox="25 5 165 20">
            <g>
              <path d="M 32 18 L 140 18" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10"
                pointer-events="stroke" />
              <polygon points="160,18 150,28 140,18 150,8" fill="#fff" stroke="#222" stroke-width="2.8" />
            </g>
          </svg>
        </span>
        <span class="font-semibold text-base text-gray-900">Agregaci√≥n</span>
      </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag [cdkDragData]="{ type: 'composition' }" (cdkDragEnded)="onDragEnded($event)">
      <div class="flex items-center gap-4 w-full justify-center py-1">
        <span class="inline-block align-middle" style="width:100px;height:20px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="115%" height="100%" viewBox="20 5 165 20">
            <g>
              <path d="M 32 18 L 140 18" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10"
                pointer-events="stroke" />
              <polygon points="160,18 150,28 140,18 150,8" fill="#222" stroke="#222" stroke-width="2.8" />
            </g>
          </svg>
        </span>
        <span class="font-semibold text-base text-gray-900">Composici√≥n</span>
      </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition flex items-center"
      cdkDrag [cdkDragData]="{ type: 'dependency' }" (cdkDragEnded)="onDragEnded($event)">
      <div class="flex items-center gap-4 w-full justify-center py-1">
        <span class="inline-block align-middle" style="width:100px;height:28px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="110%" height="100%" viewBox="20 5 165 20">
            <g>
              <path d="M 32 18 L 150 18" fill="none" stroke="#888" stroke-width="2.8" stroke-miterlimit="10"
                stroke-dasharray="4 3" pointer-events="stroke" />
              <path d="M 170 18 L 150 28 L 150 8 Z" fill="none" stroke="#888" stroke-width="2.8" stroke-miterlimit="10"
                pointer-events="all" />
            </g>
          </svg>
        </span>
        <span class="font-semibold text-base text-gray-900">Dependencia</span>
      </div>
    </div>
  </div>
  }

  <div class="w-full">
    <button
      class="w-full bg-slate-700 text-white rounded-lg py-3 font-semibold mb-2 flex items-center justify-center gap-1 shadow-md transition hover:bg-slate-800"
      (click)="showActionsImports = !showActionsImports">
      <span class="text-center">Importaciones</span>
      <span>
        @if (showActionsImports) {
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
        </svg>
        } @else {
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
        </svg>
        }
      </span>
    </button>
    @if(showActionsImports){
    <div class="mb-2 w-full flex flex-col gap-2">
      <!-- Bot√≥n visual -->
      <label for="imagenImport"
        class="cursor-pointer w-full bg-cyan-700 hover:bg-cyan-900 text-white rounded-lg py-3 font-semibold shadow-lg shadow-cyan-500/50 transition flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#fff" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
          <path d="M16 3v5H8V3" />
          <rect x="8" y="15" width="8" height="4" rx="1" />
        </svg>
        <span>Importar Imagen</span>
      </label>

      <!-- Input real -->
      <input type="file" id="imagenImport" accept="image/*" class="hidden" (change)="onImportImage($event)" />
    </div>

    }



    <!-- Men√∫ comprimido de acciones -->
    <div class="overflow-y-auto space-y-2 w-full">
      <div class="w-full">
        <button
          class="w-full bg-slate-700 text-white rounded-lg py-3 font-semibold mb-2 flex items-center justify-center gap-1 shadow-md transition hover:bg-slate-800"
          (click)="showActions = !showActions">
          <span class="text-center">Exportaciones</span>
          <span>
            @if (showActions) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
            } @else {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
            }
          </span>
        </button>
      </div>
      @if (showActions) {
      <div class="mb-2 w-full flex flex-col gap-2">
        <button
          class="w-full bg-cyan-700 hover:bg-cyan-900 text-white rounded-lg py-3 font-semibold shadow-lg shadow-cyan-500/50 transition flex items-center justify-center gap-2"
          (click)="onSaveClicked()">
          <span class="flex items-center justify-center gap-2 w-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#fff" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="#fff" fill="none" />
              <path d="M16 3v5H8V3" stroke="#fff" fill="none" />
              <rect x="8" y="15" width="8" height="4" rx="1" stroke="#fff" fill="none" />
            </svg>
            <span class="flex items-center justify-center">Exportar a Backend</span>
          </span>
        </button>
        <button
          class="w-full bg-cyan-700 hover:bg-cyan-900 text-white rounded-lg py-3 font-semibold shadow-lg shadow-cyan-500/50 transition flex items-center justify-center gap-2"
          (click)="exportImage()">
          <span class="flex flex-row items-center justify-center gap-2 w-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24"
              stroke-width="2" stroke="#fff" class="inline-block align-middle">
              <rect x="3" y="5" width="18" height="14" rx="2" fill="none" stroke="#fff" />
              <circle cx="8" cy="10" r="2" fill="none" stroke="#fff" />
              <path d="M21 19l-5-7-4 5-3-4-4 6" stroke="#fff" fill="none" />
            </svg>
            <span class="font-medium align-middle">Exportar como Imagen</span>
          </span>
        </button>
        <button
          class="w-full bg-cyan-700 hover:bg-cyan-900 text-white rounded-lg py-3 font-semibold shadow-lg shadow-cyan-500/50 transition flex items-center justify-center gap-2"
          (click)="exportSql()">
          <span class="flex flex-row items-center justify-center gap-2 w-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24"
              stroke-width="2" stroke="#fff" class="inline-block align-middle">
              <ellipse cx="12" cy="7" rx="8" ry="3" fill="none" stroke="#fff" />
              <path d="M4 7v10c0 1.66 3.58 3 8 3s8-1.34 8-3V7" stroke="#fff" fill="none" />
              <path d="M4 17c0 1.66 3.58 3 8 3s8-1.34 8-3" stroke="#fff" fill="none" />
            </svg>
            <span class="font-medium align-middle">Exportar como SQL</span>
          </span>
        </button>
        <button
          class="w-full bg-cyan-700 hover:bg-cyan-900 text-white rounded-lg py-3 font-semibold shadow-lg shadow-cyan-500/50 transition flex items-center justify-center gap-2"
          (click)="exportSql()">
          <span class="flex flex-row items-center justify-center gap-2 w-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#fff" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="#fff" fill="none" />
              <path d="M16 3v5H8V3" stroke="#fff" fill="none" />
              <rect x="8" y="15" width="8" height="4" rx="1" stroke="#fff" fill="none" />
            </svg>
            <span class="font-medium align-middle">Exportar Flutter</span>
          </span>
        </button>
      </div>
      }
    </div>
    <button
      class="w-full bg-cyan-700 hover:bg-cyan-900 text-white rounded-lg py-3 font-semibold shadow-lg shadow-cyan-500/50 transition flex items-center justify-center gap-2"
      (click)="copyRoomCode()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" />
      </svg>
      Copiar c√≥digo de sala
    </button>
    @if (copied() == true) {
    <small class="text-green-600 mt-1 block text-center">¬°Copiado!</small>
    }

    <!-- Chatbot panel -->
    <div class="chatbot-panel bg-white rounded-lg shadow-md p-3 space-y-2">
      <h4 class="font-semibold text-gray-700">ü§ñ Generar modelo</h4>

      <div class="flex space-x-2">
        <textarea [(ngModel)]="prompt"
          class="w-full border rounded-md p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"
          placeholder="Describe tu modelo aqu√≠..." rows="3"></textarea>

        <button (click)="toggleVoiceInput()"
          class="flex-shrink-0 px-3 py-2 bg-cyan-800 text-white rounded-lg flex items-center justify-center transition hover:bg-cyan-900 shadow-md">
          @if (recognizing()==true) {
          <span>‚èπÔ∏è</span>
          }
          @else {
          <span>üé§</span>
          }
        </button>
      </div>

      <button
        class="w-full bg-cyan-800 text-white rounded-lg py-3 font-bold hover:bg-cyan-900 transition shadow-lg shadow-cyan-500/50"
        (click)="onGenerate()">
        Generar
      </button>
    </div>


    <!-- Panel de validaciones -->
    <div class="validation-panel bg-white rounded-lg shadow-md p-2">
      <div class="flex justify-between items-center cursor-pointer" (click)="toggleValidationPanel()">
        <h4 class="font-semibold text-gray-700">üîç Sugerencias del modelo</h4>
        <span class="text-xl">
          @if (validationCollapsed()) {
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#8B5CF6" stroke-width="2" />
            <line x1="12" y1="8" x2="12" y2="16" stroke="#8B5CF6" stroke-width="2" />
            <line x1="8" y1="12" x2="16" y2="12" stroke="#8B5CF6" stroke-width="2" />
          </svg>
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#8B5CF6" stroke-width="2" />
            <line x1="8" y1="12" x2="16" y2="12" stroke="#8B5CF6" stroke-width="2" />
          </svg>
          }
        </span>
      </div>

      <button class="mt-2 w-full bg-cyan-500 text-white rounded-lg py-1.5 font-medium hover:bg-cyan-600 transition"
        (click)="analyzeNow()" [disabled]="analyzingModel()">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="18" height="18" viewBox="0 0 24 24"
          fill="none">
          <circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2" />
          <line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2" stroke-linecap="round" />
        </svg>
        @if (!analyzingModel()) {
        <span>Analizar modelo</span>
        }
        @if (analyzingModel()) {
        <span>Analizando...</span>
        }
      </button>

      @if (!validationCollapsed()) {
      <div class="mt-3 text-sm text-gray-700 space-y-3 max-h-40 overflow-y-auto pr-2">
        @if (analyzingModel()) {
        <p class="italic text-purple-500 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1 animate-spin" width="18" height="18"
            viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#A78BFA" stroke-width="4" opacity="0.3" />
            <path d="M12 2a10 10 0 0 1 10 10" stroke="#8B5CF6" stroke-width="4" stroke-linecap="round" />
          </svg>
          Analizando sugerencias del modelo...
        </p>
        } @else if (!validationResult()) {
        <p class="italic text-gray-400">No hay validaciones a√∫n.</p>
        } @else {
        <!-- Validas -->
        <div>
          <h5 class="text-green-600 font-semibold mb-1">‚úÖ Relaciones v√°lidas</h5>
          <ul class="list-disc pl-5 space-y-1">
            @for (v of validationResult().analysis.validas; track v) {
            <li>
              <strong>{{ v.relacion }}</strong><br />
              <small class="text-gray-600">{{ v.razon }}</small>
            </li>
            }
          </ul>
        </div>

        <!-- Errores -->
        <div>
          <h5 class="text-red-600 font-semibold mb-1">‚ùå Errores</h5>
          <ul class="list-disc pl-5 space-y-2">
            @for (e of validationResult().analysis.errores; track e) {
            <li>
              <strong>{{ e.relacion }}</strong><br />
              <small class="text-gray-600">{{ e.problema }}</small><br />
              <em class="text-purple-600">üí° Sugerencia: {{ e.sugerencia }}</em>
            </li>
            }
          </ul>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>